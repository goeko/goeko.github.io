<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>goEko's Financial Calculator</title>
    <script src="./vue@2.js"></script>
</head>
<style>
        ::root {
            --highlight-font-size: 1.2em;
        }
        * {
          font-family: Arial, Helvetica, sans-serif;
        }
        #app {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }
        #app > * {
            flex: 1 1 300px;
            margin: 0 10px 10px 0;
            padding: 10px;
            border: 1px solid black;
        }
        fieldset {
            border: none;
            padding: 0;
        }
        legend {
            display: block;
            width: 100%;
            padding: 0 0.5em 0.5em 0;
            margin-bottom: 0.75em;
            border-bottom: 1px solid black;
        }
        p {
            margin: 0 0 10px 0;
            display: flex;
            flex-direction: row;
            align-items: center;
            align-content: center;
        }
        legend {
            font-weight: bold;
        }
        label {
            display: inline-block;
            width: 350px;
        }
        input {
            width: 120px;
            text-align: right;
            font-size: var(--highlight-font-size);
            flex-basis: content;
        }
        input[type="checkbox"] {
            width: auto;
            margin: 0 10px 0 20px;
        }
        span {
            display: block;
            width: 175px;
            font-weight: bold;
            text-align: right;
        }
        span::after {
            content: " €";
        }
        p.darlehen {
            color: blue;
            font-size: var(--highlight-font-size);
        }
        p.rest_schuld {
            color: red;
            font-size: var(--highlight-font-size);
        }
        p.monatliche_rate {
            color: green;
            font-size: var(--highlight-font-size);
        }
        input[type="number"]{
            padding: 0.1em 0 0.1em 0.5em;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            transform: scale(1.25) translateX(2px);
        }
        #neukauf_parameter {
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            flex: 1 1 300px;
            /*padding: 1em 0 0;*/
            margin: 0 0 0.75em;
            border: none;
            border-top: 1px solid black;
        }
        label.neukauf {
            width: 120px;
        }
        #neukauf_parameter label:last-child {
            width: 100px;

        }
        #sonderzahlung_wrapper input {
            width: 11em !important;
            min-width: 11em !important;
        }
        table {
            border-collapse: collapse;
            border: 1px solid black;
        }
        table th {
            font-weight: bold;
        }
        table th,
        table td {
            border: 1px solid black;
            padding: 0.2em 0.75em;
            text-align: right;
        }
        .baureno-wrapper {
            padding-top: 0.75em;
            border-top: 1px solid black;
        }

    </style>
<body>
    <h1>Kreditrechner für Ratenkredite als Annuitätendarlehen</h1>
    <p>Vereinbarte Darlehens Sondertilgung berücksichtigt</p>
    <div id="app">
        <div>
            <fieldset class="params">
                <legend>Darlehen Parameter
                    <button @click="resetAll">Werte zurücksetzen</button>
                    <button @click="copyToClipboard">Kopiere Link zum teilen</button>
                </legend>
                <p>
                    <label for="kaufpreis">Kaufpreis der Immobilie:
                        <label for="neukauf" class="neukauf"><input id="neukauf" v-model="neukauf" type="checkbox"> Neukauf?</label>
                    </label> <input id="kaufpreis" v-model.number="kaufpreis" type="number" step="1000">
                </p>

                <fieldset id="neukauf_parameter" v-show="neukauf">
                    <legend>Kosten beim Neukauf</legend>
                    <p><label for="grundsteuer">Grunderwerbssteuer in % ({{ (kaufpreis / 100 * grundsteuer).toFixed(2) }} €): </label> <input id="grundsteuer" v-model.number="grundsteuer" type="number" :min="0" step="0.01"> <label for="includeGrundsteuer"><input id="includeGrundsteuer" v-model="includeGrundsteuer" type="checkbox"> Inkl.</label></p>
                    <p><label for="notargericht">Notar- und Gerichtskosten in % ({{ (kaufpreis / 100 * notargericht).toFixed(2) }} €): </label> <input id="notargericht" v-model.number="notargericht" type="number" :min="0" step="0.01"> <label for="includeNotargericht"><input id="includeNotargericht" v-model="includeNotargericht" type="checkbox"> Inkl.</label></p>
                    <p><label for="makler">Maklerprovision in % ({{ (kaufpreis / 100 * makler).toFixed(2) }} €): </label> <input id="makler" v-model.number="makler" type="number" step="0.01" :min="0" step="0.01"> <label for="includeMakler"><input id="includeMakler" v-model="includeMakler" type="checkbox"> Inkl.</label></p>
                </fieldset>
                <p class="baureno-wrapper"><label for="baureno">Bau-/Renovierungskosten: </label> <input id="baureno" v-model.number="baureno" type="number" step="500" :min="0"></p>
                <p class="eigenkapital-wrapper"><label for="eigenkapital">Eigenkapital <small>(min. Steuern, Notar und Auslagen)</small>: </label> <input id="eigenkapital" v-model.number="eigenkapital" type="number" step="500" :min="0"></p>
                <hr>
                <p><label for="nominal">Nominalzinssatz: </label> <input id="nominal" v-model.number="nominal" type="number" step="0.01" :min="0"></p>
                <p><label for="tilgung">Anfängliche Tilgung in % p.a.: </label> <input id="tilgung" v-model.number="tilgung" type="number" step="0.01" :min="0"></p>
                <p><label for="jahre">Dauer der Zinsbindung: </label> <input id="jahre" v-model.number="jahre" type="number" step="1" :min="1"></p>
                <hr>
                <p class="gesamtkosten"><label>Gesamtkosten:</label> <span>{{ gesamtkosten }}</span></p>
                <p class="darlehen"><label>Darlehensbetrag:</label> <span>{{ darlehen }}</span></p>
                <p class="jaehrliche_ratenzahlung"><label>Jährliche Ratenzahlung nominal:</label> <span>{{ jaehrliche_ratenzahlung }}</span></p>
                <p class="monatliche_rate"><label>Monatliche Ratenzahlung nominal:</label> <span>{{ monatliche_rate }}</span></p>
                <p class="getilgter_betrag_zum_ende"><label>Getilgter Betrag <small>(bis zum Ende der Zinsbindung)</small>:</label> <span>{{ getilgter_betrag_zum_ende }}</span></p>
                <p class="rest_schuld"><label>Restschuld <small>(am Ende der Zinsbindung)</small>:</label> <span>{{ rest_schuld }}</span></p>
                <p class="bereits_gezahlte_summe"><label>Bereits bezahlt Summe:</label> <span>{{ bereits_gezahlte_summe }}</span></p>
                <p class="gezahlte_zinsen"><label>Davon Zinsen <small>(Steuerbefreit?)</small>:</label> <span>{{ gezahlte_zinsen }}</span></p>
            </fieldset>
        </div>


        <div>
            <fieldset id="sonderzahlung_wrapper">
                <legend>Sonderzahlungen ({{jahre}} Jahre)</legend>
                <p><label for="max_sonderzahlung">Max. Sonderzahlung in % je p.a. ({{ Number(darlehen / 100 * max_sonderzahlung).toFixed(2) }} €): </label> <input id="max_sonderzahlung" v-model.number="max_sonderzahlung" type="number" step="0.01"></p>
                <hr>
                <p v-for="index in jahre" :key="index">
                    <label :for="'sonderzahlung' + index">Sonderzahlung Jahr {{ index }}: </label>
                    <input :id="'sonderzahlung' + index" v-model.number="sonderzahlungen[index - 1]" type="number" :max="maxSonderzahlungValue" :min="0" step="500">
                </p>
            </fieldset>
        </div>

        <div>
            <fieldset id="tilgungsplan_wrapper">
                <legend>Tilgungsplan</legend>
                <table border="1">
                    <thead>
                    <tr>
                        <th>Jahr</th>
                        <th>Tilgung</th>
                        <th>Zinsen</th>
                        <th>Ausgaben p.a.</th>
                        <th>Getilgter Betrag</th>
                        <th>Restschuld</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr v-for="year in tilgungsplan" :key="year.jahr">
                        <td>{{ year.jahr }}</td>
                        <td>{{ parseFloat(year.tilgung).toFixed(2) }}&nbsp;€</td>
                        <td>{{ parseFloat(year.zinsen).toFixed(2) }}&nbsp;€</td>
                        <td>{{ parseFloat(year.tilgung + year.zinsen).toFixed(2) }}&nbsp;€</td>
                        <td>{{ parseFloat(year.getilgter_betrag_zum_ende).toFixed(2) }}&nbsp;€</td>
                        <td>{{ parseFloat(year.restschuld).toFixed(2) }}&nbsp;€</td>
                    </tr>
                    </tbody>
                </table>
            </fieldset>
        </div>

    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                baseurl: 'https://goeko.github.io/kreditrechner.html',
            /*
                kaufpreis: 350000,
                neukauf: false,
                grundsteuer: 3.5,
                notargericht: 1.5,
                makler: 3.57,
                baureno: 8000,
                eigenkapital: 17500,
                nominal: 3.03,
                tilgung: 2.67,
                jahre: 10,
                max_sonderzahlung: 5, // Beispielwert
                sonderzahlungen: Array(10).fill(0),
                monatliche_rate: 0,
                getilgter_betrag_zum_ende: 0,
                rest_schuld: 0,
                jaehrliche_ratenzahlung: 0,
                bereits_gezahlte_summe: 0,
                gezahlte_zinsen: 0,
                includeGrundsteuer: true,
                includeNotargericht: true,
                includeMakler: true,
                */
                kaufpreis: 180000,
                neukauf: true,
                grundsteuer: 3.5,
                notargericht: 1.5,
                makler: 3.57,
                baureno: 0,
                eigenkapital: 0,
                nominal: 3.03,
                tilgung: 2.67,
                jahre: 10,
                max_sonderzahlung: 5,
                sonderzahlungen: Array(30).fill(0),
                monatliche_rate: 0,
                getilgter_betrag_zum_ende: 0,
                rest_schuld: 0,
                jaehrliche_ratenzahlung: 0,
                bereits_gezahlte_summe: 0,
                gezahlte_zinsen: 0,
                includeGrundsteuer: true,
                includeNotargericht: true,
                includeMakler: true,
                tilgungsplan: [],

                originalData: null
            },
            computed: {
                gesamtkosten: function() {
                    var grundsteuer = this.includeGrundsteuer ? this.kaufpreis * this.grundsteuer / 100 : 0;
                    var notargericht = this.includeNotargericht ? this.kaufpreis * this.notargericht / 100 : 0;
                    var makler = this.includeMakler ? this.kaufpreis * this.makler / 100 : 0;
                    return this.kaufpreis + this.baureno + grundsteuer + notargericht + makler;
                },
                darlehen: function() {
                    var darlehen = this.gesamtkosten - this.eigenkapital;
                    return this.FloatNum(Math.max(0, darlehen));
                },
                maxSonderzahlungValue: function() {
                    return this.darlehen * this.max_sonderzahlung / 100;
                },
                bereits_gezahlte_summe: function() {
                    var monatliche_rate = this.monatliche_rate;
                    var zahlungenProJahr = 12;
                    var jahre = this.jahre;
                    var bereits_gezahlte_summe = (monatliche_rate * zahlungenProJahr) * jahre;
                    return this.FloatNum(bereits_gezahlte_summe);
                },
            },
            methods: {
                RR: function() {
                    var darlehen = this.darlehen;
                    var nominal = this.nominal;
                    var tilgung = this.tilgung;
                    var zahlungenProJahr = 12;
                    var jahre = this.jahre;
                    var monatliche_rate = this.FloatNum((darlehen * (nominal + tilgung) / zahlungenProJahr) / 100);
                    var festzinz = (darlehen * (nominal + tilgung) / zahlungenProJahr) / 100;
                    var rest_schuld = darlehen;
                    var tilgungsplan = [];
                    var i = 1;
                    while(i <= (jahre * zahlungenProJahr) && rest_schuld > 0){
                        var jaehrliche_zinsen_nominal = (rest_schuld * (nominal) / zahlungenProJahr) / 100;
                        var jaehrliche_tilgung = festzinz - jaehrliche_zinsen_nominal;
                        if (i % 12 === 0) {
                            var jahr = i / 12;
                            if (jahr <= this.sonderzahlungen.length) {
                                rest_schuld = rest_schuld - this.sonderzahlungen[jahr - 1];
                            }
                            tilgungsplan.push({
                                jahr: jahr,
                                tilgung: jaehrliche_tilgung * 12,
                                zinsen: jaehrliche_zinsen_nominal * 12,
                                restschuld: rest_schuld - jaehrliche_tilgung,
                                getilgter_betrag_zum_ende: this.darlehen - rest_schuld + jaehrliche_tilgung
                            });
                        }
                        rest_schuld = rest_schuld - jaehrliche_tilgung;
                        i++;
                    }
                    var jaehrliche_ratenzahlung = this.FloatNum(darlehen * (nominal + tilgung)) / 100;
                    var getilgter_betrag_zum_ende = this.FloatNum(this.darlehen - rest_schuld);
                    var bereits_gezahlte_summe = this.FloatNum((monatliche_rate * zahlungenProJahr) * jahre);
                    var gezahlte_zinsen = this.FloatNum(bereits_gezahlte_summe - getilgter_betrag_zum_ende);

                    if (gezahlte_zinsen < 0 || rest_schuld <= 0) {
                        throw new Error("Die kalkulierten Zinsen (Davon Zinsen) dürfen nicht negativ werden.");
                    }

                    this.tilgungsplan = tilgungsplan;
                    this.monatliche_rate = monatliche_rate;
                    this.getilgter_betrag_zum_ende = getilgter_betrag_zum_ende;
                    this.rest_schuld = this.FloatNum(rest_schuld > 0 ? this.FloatNum(rest_schuld) : 0.00);
                    this.jaehrliche_ratenzahlung = jaehrliche_ratenzahlung;
                    this.bereits_gezahlte_summe = bereits_gezahlte_summe;
                    this.gezahlte_zinsen = gezahlte_zinsen;
                },
                FloatNum: function(myFloat) {
                    return parseFloat(myFloat).toFixed(2);
                },
                loadFromLocalStorage() {
                    if(localStorage.getItem('store')) {
                        try {
                            let storedData = JSON.parse(localStorage.getItem('store'));
                            Object.keys(storedData).forEach(key => {
                                this.$data[key] = storedData[key];
                            });
                        } catch(e) {
                            console.error('Fehler beim Abrufen von Daten aus dem localStorage', e);
                        }
                    }
                },
                copyToClipboard: function() {
                    var copyData = this.$data;
                    delete copyData.gesamtkosten;
                    delete copyData.darlehen;
                    delete copyData.jährliche_rate;
                    delete copyData.monatliche_rate;
                    delete copyData.getilgter_betrag_zum_ende;
                    delete copyData.rest_schuld;
                    delete copyData.bereits_gezahlte_summe;
                    delete copyData.gezahlte_zinsen;


                    delete copyData.originalData;
                    delete copyData.tilgungsplan;
                    localStorage.setItem('store', JSON.stringify(copyData));
                    var url = this.baseurl + "?v=" +( new Date().getTime() )+ "&store=" + encodeURIComponent(localStorage.getItem('store'));
                    console.log(url);

                    navigator.clipboard.writeText(url);
                },
                resetData() {
                    Object.assign(this.$data, this.originalData);
                },
                resetAll() {
                    localStorage.removeItem('store');
                    this.resetData();
                    window.location.reload(true);
                }
            },
            watch: {
                kaufpreis: function() {
                    this.RR();
                },
                neukauf: function(newValue, oldValue) {
                    if (!newValue) { // Wenn neukauf deaktiviert ist
                        this.includeGrundsteuer = false;
                        this.includeNotargericht = false;
                        this.includeMakler = false;
                    } else {
                        this.includeGrundsteuer = true;
                        this.includeNotargericht = true;
                        this.includeMakler = true;
                    }
                    if (newValue !== oldValue) {
                        var grundsteuer = (this.includeGrundsteuer == true) ? this.grundsteuer : 0;
                        var notargericht = (this.includeNotargericht == true) ? this.notargericht : 0;
                        var makler = (this.includeMakler == true) ? this.makler : 0;
                        this.eigenkapital = (this.kaufpreis / 100 * (grundsteuer + notargericht + makler)).toFixed(2)
                    }
                },
                grundsteuer: function() {
                    this.RR();
                },
                notargericht: function() {
                    this.RR();
                },
                makler: function() {
                    this.RR();
                },
                baureno: function() {
                    this.RR();
                },
                eigenkapital: function() {
                    this.RR();
                },
                nominal: function() {
                    this.RR();
                },
                tilgung: function() {
                    this.RR();
                },
                jahre: function() {
                    this.RR();
                },
                max_sonderzahlung: function() {
                    this.RR();
                },
                sonderzahlungen: {
                    handler: function() {
                        this.RR();
                    },
                    deep: true
                },
                includeGrundsteuer: function() {
                    this.RR();
                },
                includeNotargericht: function() {
                    this.RR();
                },
                includeMakler: function() {
                    this.RR();
                },
                '$data': {
                  handler: function (val, oldVal) {
                    console.log('store changed');
                    localStorage.setItem('store', JSON.stringify(val));
                  },
                  deep: true
                }
            },
            created: function() {
                this.RR();

                this.originalData = {...this.$data};
                if (localStorage.getItem('store')) {
                  try {
                    this.$data = JSON.parse(localStorage.getItem('store'));
                  } catch(e) {
                    localStorage.removeItem('store');
                  }
                }
            },
            mounted() {
                var urlParams = new URLSearchParams(window.location.search);
                if(urlParams.has('store')) {
                    localStorage.removeItem('store');
                    var storedData = JSON.parse(decodeURIComponent(urlParams.get('store')));
                    Object.keys(storedData).forEach(key => {
                        this.$data[key] = storedData[key];
                    });
                    this.RR();
                } else {
                    this.loadFromLocalStorage();
                }
            }
        });
    </script>
</body>
</html>
